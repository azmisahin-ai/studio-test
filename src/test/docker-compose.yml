# /**
#  * @file docker-compose.yml
#  * @author Azmi ŞAHİN (azmisahin@outlook.com)
#  * @brief running multi-container Docker applications.
#  * @version 0.1.2
#  * @date 2024-01-01
#  *
#  * @copyright Copyright (c) 2024
#  */
version: '3.8'

services:

  application:

    container_name: $APP_NAME-$APP_ENV

    build:
      context: ../..
      dockerfile: deploy/Dockerfile.$DISTRIB_ID
      target: $APP_ENV
      args:
        # product
        - APP_ENV=$APP_ENV
        - APP_NAME=$APP_NAME

        # build
        - BASE_IMAGE=$BASE_IMAGE
        - WORKSPACE_FOLDER=$WORKSPACE_FOLDER

        # application

        # SWICH
        - SWICH_TRACKING_TRACE=$SWICH_TRACKING_TRACE
        - SWICH_TRACKING_DEBUG=$SWICH_TRACKING_DEBUG
        - SWICH_TRACKING_INFO=$SWICH_TRACKING_INFO
        - SWICH_TRACKING_WARN=$SWICH_TRACKING_WARN
        - SWICH_TRACKING_ERROR=$SWICH_TRACKING_ERROR
        - SWICH_TRACKING_VERBOSE=$SWICH_TRACKING_VERBOSE
        - SWICH_TRACKING_REPORT=$SWICH_TRACKING_REPORT

        # SERVER
        - HOST_IP=$HOST_IP
        - TCP_PORT=$TCP_PORT

    environment:
      # FLASK
      - FLASK_DEBUG=TRUE
      - FLASK_APP=src/app

    volumes:
      # .devcontainer process case sensitive ${localWorkspaceFolderBasename} [ relevant folder name ]
      # You can use this feature if you want to commit changes to your local work environment.
      - ../../..:/workspaces:cached
      # to separate virtual environments
      - venv-$APP_ENV:/venv-$APP_ENV

    # If the docker file does not run a command, you should put it on hold.
    # otherwise [ Error: An error occurred setting up the container. ]
    command: sleep infinity
    # web services must be launched in development environments.
    # command: /venv-$APP_ENV/bin/gunicorn --bind $HOST_IP:$TCP_PORT src.app:app

    ports:
      - "$TCP_PORT:$TCP_PORT"

    # base limitation
    cpus: $RESOURCE_CPUS
    mem_limit: $RESOURCE_MEMORY

    deploy:
      # base resources
      resources:
        # resources limitation
        reservations:
          devices:
            - driver: nvidia
              count: $RESOURCE_GPUS
              capabilities:
                - gpu
          cpus: $RESOURCE_CPUS
          memory: $RESOURCE_MEMORY

volumes:
  venv-development:
  venv-production:
  venv-test:
